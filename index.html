<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">


    <link rel="stylesheet" href="css/spectre.min.css">
<link rel="stylesheet" href="css/spectre-exp.min.css">
<style media="screen">
  .card {margin-top: 3vh;height:92vh;}
</style>
    <title></title>
  </head>
  <body>

    <div class="container  ">
      <div class="columns">
        <div class="column col-6">

          <div class="card bg-gray">

            <div class="card-header">
              <div class="card-title h5">QUESTIONS</div>

            </div>
            <div class="card-body">


              <div class="form-group">
                <label class="form-label" for="qfield">Questions</label>
                <textarea class="form-input" id="qfield" autofocus placeholder="COLLER" rows="7"></textarea>
                <button type="button" onclick="pastText('qfield')" class="btn btn-sm btn-primary" name="button">Coller</button>
                <button type="button" onclick="clearField('qfield')" class="btn btn-sm btn-error" name="button">Vider</button>
              </div>
              <div class="form-group">
                <label class="form-label" for="reponsefield">Reponces</label>
                <textarea class="form-input" id="reponsefield" placeholder="COLLER" rows="7"></textarea>
                <button type="button" onclick="pastText('reponsefield')" class="btn btn-sm btn-primary" name="button">Coller</button>
                <button type="button" onclick="clearField('reponsefield')" class="btn btn-sm btn-error" name="button">Vider</button>
              </div>


            </div>
            <div class="card-footer">
              <div class="totl loading" ></div>

            </div>
          </div>


        </div>
        <div class="column col-6">

          <div class="card bg-gray">

            <div class="card-header">
              <div class="card-title h5">PARAMETRES</div>

            </div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label" for="module">Module</label>

                <select class="form-select " id="module">
                  <option value="">Module</option>
                  <option value="Anatomie Pathologique">Anatomie Pathologique</option>
                  <option value="Anatomie1">Anatomie1</option>
                  <option value="Anatomie2">Anatomie2</option>
                  <option value="Biochimie1">Biochimie1</option>
                  <option value="Biochimie2">Biochimie2</option>
                  <option value="Biophysique1">Biophysique1</option>
                  <option value="Biophysique2">Biophysique2</option>
                  <option value="Biostatistique">Biostatistique</option>
                  <option value="Cardiologie-Vasculaire">Cardiologie-Vasculaire</option>
                  <option value="Chimie">Chimie</option>
                  <option value="Cytologie">Cytologie</option>
                  <option value="Deontologie1">Deontologie1</option>
                  <option value="Deontologie6">Deontologie6</option>
                  <option value="Dermatologie">Dermatologie</option>
                  <option value="Economie de la Sante">Economie de la Sante</option>
                  <option value="Embryologie">Embryologie</option>
                  <option value="Embryologie">Embryologie</option>
                  <option value="Endocrinologie">Endocrinologie</option>
                  <option value="Epidémiologie">Epidémiologie</option>
                  <option value="Génétique">Génétique</option>
                  <option value="Gynécologie-Obstétrique">Gynécologie-Obstétrique</option>
                  <option value="Hématologie">Hématologie</option>
                  <option value="Hépato-Gastro-entérologie">Hépato-Gastro-entérologie</option>
                  <option value="Histologie1">Histologie1</option>
                  <option value="Histologie2">Histologie2</option>
                  <option value="Immunologie">Immunologie</option>
                  <option value="Informatique">Informatique</option>
                  <option value="Maladies Infectieuses">Maladies Infectieuses</option>
                  <option value="Médecine de Travail">Médecine de Travail</option>
                  <option value="Médecine Légale">Médecine Légale</option>
                  <option value="Microbio-Bactériologie">Microbio-Bactériologie</option>
                  <option value="Neurologie">Neurologie</option>
                  <option value="Ophtalmologie">Ophtalmologie</option>
                  <option value="Orthopédie-Traumato">Orthopédie-Traumato</option>
                  <option value="Oto-rhino-laryngologie">Oto-rhino-laryngologie</option>
                  <option value="Parasitologie">Parasitologie</option>
                  <option value="Pédiatrie">Pédiatrie</option>
                  <option value="Pharmacologie">Pharmacologie</option>
                  <option value="Physiologie1">Physiologie1</option>
                  <option value="Physiopathologie">Physiopathologie</option>
                  <option value="Pneumo-phtisiologie">Pneumo-phtisiologie</option>
                  <option value="Ppysiologie2">Ppysiologie2</option>
                  <option value="Psychiatrie">Psychiatrie</option>
                  <option value="Radiologie">Radiologie</option>
                  <option value="Rhumatologie">Rhumatologie</option>
                  <option value="Sémiologie">Sémiologie</option>
                  <option value="Thérapeutique">Thérapeutique</option>
                  <option value="Urgences Médico-chirurgicales">Urgences Médico-chirurgicales</option>
                  <option value="Uro-Néphrologie">Uro-Néphrologie</option>

                </select>

              </div>

              <div class="form-group">
                <label class="form-label" for="aneeAnnee">Annee</label>
   <select class="form-select " id="aneeAnnee">
<option value="2000">2000</option>
<option value="2001">2001</option>
<option value="2002">2002</option>
<option value="2003">2003</option>
<option value="2004">2004</option>
<option value="2005">2005</option>
<option value="2006">2006</option>
<option value="2007">2007</option>
<option value="2008">2008</option>
<option value="2009">2009</option>
<option value="2010">2010</option>
<option value="2011">2011</option>
<option value="2012">2012</option>
<option value="2013">2013</option>
<option value="2014">2014</option>
<option value="2015">2015</option>
<option value="2016">2016</option>
<option value="2017">2017</option>
<option value="2018" selected>2018</option>


     </select>
              </div>



              <div class="form-group">
                <label class="form-label" for="rotation">Annee</label>
   <select class="form-select " id="rotation">
<option value="R1">R1</option>
<option value="R2">R2</option>
<option value="R3">R3</option>
<option value="R4">R4</option>
<option value="EMD1">EMD1</option>
<option value="EMD2">EMD2</option>
<option value="EMD3">EMD3</option>
<option value="RATTRAPAGE">RATTRAPAGE</option>

     </select>
              </div>


              <div class="form-group">
                <label class="form-label" for="qType">Questions</label>
                <select class="form-select " id="qType">

                  <option value="1">1 -</option>
                  <option value="2">1 )</option>
                  <option value="3">1 :</option>
                  <option value="4">1 .</option>
                  <option value="5">1 / ou /-</option>


                  <option value="6">Q1 </option>
                  <option value="7">Q1 : </option>
                  <option value="8">Q1 - </option>
                  <option value="9">Q1 ) </option>
                  <option value="10">Question1  (ou) Question 1: (ou) </option>
                  <option value="11">QCM 1 (ou) QCM 1 :</option>
                </select>
              </div>


              <div class="form-group">
                <label class="form-label" for="ChoicesType">Choix</label>
                <select class="form-select" id="choicesType">
                  <option value="1">A.</option>
                  <option value="2">a.</option>
                  <option value="3">A-proposition</option>
                  <option value="4">A) proposition</option>
                  <option value="5">a) proposition</option>
                </select>
              </div>

              <br><br>
<div id="resAlert">


</div>

            </div>
            <div class="card-footer">
              <button class="btn btn-default " onclick="preview()">voir</button>
              <button class="btn btn-primary " onclick="submit()">Ajouter</button>

            </div>
          </div>





        </div>


      </div>
    </div>


<script type="text/javascript">
const mysql      = require('mysql'),
fs = require('fs') ,
 {BrowserWindow} = require('electron').remote ,
 path=require('path') ,
 url=require('url');

const qField = document.getElementById('qfield') ,
 reponseField = document.getElementById('reponsefield') ,
qType = document.getElementById('qType') ,
choicesType = document.getElementById('choicesType') ,
resAlert = document.getElementById('resAlert') ,
regQUestions = [
  null ,
  /[0-9*]+(\s?)+\-/gi,
  /[0-9*]+(\s?)+\)/gi,
  /[0-9*]+(\s?)+\:/gi,
  /[0-9*]+(\s?)+\./gi,
  /[0-9*]+(\s?)+\/+(\s?)+(\-?)/gi,
  /[Q]+[0-9*]+(\s?)/gi,
  /[Q]+(\s?)+[0-9*]+(\s?)+\:/gi,
  /[Q]+[0-9*]+(\s?)+\-/gi,
  /[Q]+[0-9*]+(\s?)+\)/gi,
  /[Question]+(\s?)+[0-9*]+(\s?)+(\:?)/gi,
  /[QCM]+(\s?)+[0-9*]+(\s?)+(\:?)/gi,


  /[0-9*]+(\)?)+(\s?)+(\.?)+(\-?)+(\:?)+(\/?)+(\s?)/gi,
  /[Q]+[0-9*]+(\s?)+(\)?)+(\:- )/gi,


];

const regChoices = [
  null ,
  /[A-E]+\.+(\s?)/gi,
  /[a-e]+\.+(\s?)/gi,
  /[A-E]+\-+(\s?)/gi,
  /[A-E]+\)+(\s?)/gi,
  /[a-e]+\)+(\s?)/gi,
]


function sdash(d) {
let pos = parseInt(qType.value);
console.log();
console.log(regQUestions[pos]);
  return d.toString().replace(regQUestions[pos], '##');
}


function preview(){
  let fspp = firstSplit(qField.value) ,
 resData = [] , qsssp ,qqp;
for (var i = 0; i < fspp.length; i++) {
   qsssp =   secondSplit(fspp[i]) ;
   qqp = qsssp[0] ;
   qsssp.shift();
choicesp = qsssp.join('<br>* ');
resData.push('<tr><td>'+(i +1) + ' '+qqp+'</td><td>*'+choicesp+'</td></tr>');
}



fs.writeFile("main.txt", '<table class="table table-striped"><tr><th style="width:40%">Question</th><th>choix</th></tr>'+resData.join('')+'</table>', function(err) {
    if(err) {
        return console.log(err);
    }



    let win = new BrowserWindow({ width: 1000, height: 800,modal: true,frame:true  });
       win.on('close', function () { win = null ;})
       win.loadURL(url.format({
            pathname:path.join(__dirname,'preview.html'),
            protocol:'file',
            slashes:true
    }))
    win.setMenu(null)
       win.show();








 });



}

function submit(){
  let fsp = firstSplit(qField.value) ,
  responces = splitResponces();

if (responces.length !== fsp.length) {
  resAlert.innerHTML = `<div class="toast toast-error"> Erreur  : Questions ${fsp.length}  / reponces ${responces.length}</div>`;
  return;
}

if (responces.length < 5) {
  resAlert.innerHTML = `<div class="toast toast-error"> Erreur  : Nombre des Questions ${fsp.length}  </div>`;
  return;
}

let moddd =  document.getElementById('module').value,
annee = document.getElementById('aneeAnnee').value,
rota = document.getElementById('rotation').value;

if (moddd.length <= 1) {
  resAlert.innerHTML = `<div class="toast toast-error"> Module obligatoir  </div>`;
  return;
}










resAlert.innerHTML = '<span class="label label-rounded label-success">nombre des Questions '+fsp.length+'</span>';


let data = [];
for (var i = 0; i < fsp.length; i++) {
let qsss =   secondSplit(fsp[i]) ,
qq = qsss[0] ;
qsss.shift();
choices = qsss;
data.push("('"+annee+"','"+rota+"','"+moddd+"','"+qq.replace(/'/g, "\\'")+"','"+choices.join(';;').replace(/'/g, "\\'")+"','"+responces[i]+"','','')");
// insert('','TEST',qq,choices.join(';;'),responces[i])
}

initConnexion();
insert2(data.join(','),function(done){
  if(done) {
    alert(responces.length +'QMS a été ajouté');
    window.location.reload()
  }  else  {
    resAlert.innerHTML = `<div class="toast toast-error"> Erreur de connexion</div>`;
  }
})
}




function firstSplit(x){
  let qc = sdash(x).split('##') , qWc = [];
  if (qc && qc .length) {
for (var i = 0; i < qc.length; i++) {
if (qc[i].length >= 20)  qWc.push(qc[i])
}
  }
  return qWc;
}


function secondSplit(r){
  let pos = parseInt(choicesType.value);

  let questAndch = r.toString().replace(regChoices[pos], ';;').split(';;'),qWc = [];;
for (var i = 0; i < questAndch.length; i++) {
  qWc.push(questAndch[i]);
}
 return qWc;
}







function choix(d) {

  return d.toString().replace(/[a-f]\./gi, '&&');
}


function  splitResponces(){
  let rr = reponsefield.value.trim().split('\n'), responses =[];
  for (var i = 0; i < rr.length; i++) {
    if(rr[i].length > 0) responses.push(rr[i].replace('A',0).replace('B',1).replace('C',2).replace('D',3).replace('E',4).split('').join('.'));
  }
return responses;
}








function pastText(id){
  setTimeout(function(){
    document.getElementById(id).value = "";
    document.getElementById(id).focus()
    document.execCommand("paste")

  },100)
}

function clearField(id){
  document.getElementById(id).value = "";
  document.getElementById(id).focus();

}





var dbi = {
  host     : 'frequency-dz.com',
  user     : 'emmysql',
  password : 'emmysql',
  database : 'hichem'
}

var connection
function testConnect(){
   connection = mysql.createConnection(dbi);
  connection.connect();
  connection.query('SELECT COUNT(id) AS CID from qcm', function (error, results, fields) {
    document.querySelector('.totl').classList.remove('loading');
    if (error) {
      document.querySelector('.totl').innerHTML = '<div class=" toast toast-error">Erreur de connexion ('+error.code+')</div>';

    }
    console.log('The solution is: ', results[0]);
     document.querySelector('.totl').innerHTML = '<div class="toast toast-success">connecté :Total '+results[0].CID+' questions </div>';
  });

  connection.end();
}


testConnect();

function initConnexion(){
   connection = mysql.createConnection(dbi);
  connection.connect();
}

function insert(ann,mod,quest,choix,rep,callback){

  var sql = "INSERT INTO qcm (annee, module,question,choix,correction,commentaire,interna) VALUES ('"+ann+"','"+mod+"','"+quest.replace(/'/g, "\\'")+"','"+choix.replace(/'/g, "\\'")+"','"+rep+"','','')";

  var query = connection.query(sql, function (error, results) {
  callback(error == false)

});
}


function insert2(data,callback){

  var sql = "INSERT INTO qcm (annee,rota, module,question,choix,correction,commentaire,interna) VALUES"+data;

  var query = connection.query(sql, function (error, results) {
  callback(error == null)

});
}






</script>





  </body>
</html>
